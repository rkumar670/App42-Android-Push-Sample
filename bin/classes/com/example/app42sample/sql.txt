create view  user_activity as SELECT m.service_id, ma.user_name, ma.device_id, ma.event,l.module, m.date, ma.sdk, ma.ip  FROM pae_web.metering_analytics ma,log_metering_analytics lm, metering m,log l where m.service_id=1 and m.id=ma.metering_id and lm.log_id=l.id and lm.metering_analytics_id=ma.id order by m.date;
drop view user_activity;

select * from user_activity where service_id=1 ;
select a.device_id, a.module, TIMESTAMPDIFF(SECOND,a.start_time, b.end_time) as time_spent , a.start_time, b.end_time from (select date as start_time, module,device_id,service_id from user_activity  where service_id=1 and event='Landed') as a , (select date as end_time, module, device_id, service_id from user_activity  where service_id=1 and event='Escaped' ) as b where a.module=b.module and a.device_id=b.device_id and b.end_time>a.start_time group by a.device_id, a.module, a.start_time order by a.start_time;
select a.device_id, a.module, TIMESTAMPDIFF(SECOND,a.start_time, b.end_time) as time_spent , a.start_time, min(b.end_time) from (select date as start_time, module,device_id,service_id from user_activity  where service_id=1 and event='Landed') as a , (select date as end_time, module, device_id, service_id from user_activity  where service_id=1 and event='Escaped' ) as b where a.module=b.module and a.device_id=b.device_id and b.end_time>a.start_time group by a.device_id, a.module, a.start_time order by a.start_time;